// Generated by CoffeeScript 1.9.2
(function() {
  App.Item = (function() {
    Item._existing = [];

    Item.elem_exist = function(id) {
      var flag, i, item, len, ref;
      flag = false;
      ref = this._existing;
      for (i = 0, len = ref.length; i < len; i++) {
        item = ref[i];
        if (item.id === id) {
          flag = true;
          break;
        }
      }
      if (flag) {
        return item;
      } else {
        return false;
      }
    };

    function Item(id1) {
      this.id = id1;
      this.set_chars();
      if (this.is_measureable()) {
        this.count = 1;
        this.change_buy_count(this.count);
      } else {
        this.buy_weight = "1";
        this.change_buy_weight(this.buy_weight);
      }
      this.show_modal();
      App.Item._existing.push(this);
    }

    Item.prototype.is_measureable = function() {
      if (this.length === "0.0" || this.length === "0" || this.length === "") {
        return false;
      } else {
        return true;
      }
    };

    Item.prototype.get_chars = function() {
      var response;
      response = null;
      $.ajax({
        type: "POST",
        url: "/1cengine/py_scripts/get_item_lwkes.py",
        async: false,
        data: "item_hash=" + this.id,
        success: function(html) {
          response = html;
          return response;
        }
      });
      return response;
    };

    Item.prototype.set_chars = function(chars) {
      var char_array, i_class, i_hash, obj, price_ul;
      chars = this.get_chars().replace(/\s+$/g, "");
      char_array = chars.split("|");
      this.length = char_array[0];
      this.weight = char_array[1];
      this.kf = char_array[2];
      this.ed_izm = char_array[3];
      this.stock = char_array[4];
      this.width = char_array[5];
      this.work_width = parseInt(char_array[6], 10) / 1000;
      this.ai_flag = char_array[7];
      this.min_length = char_array[8];
      this.max_length = char_array[9];
      i_hash = this.id.slice(0, this.id.indexOf(":"));
      i_class = this.id.slice(this.id.indexOf(":") + 1);
      if (i_hash === "0") {
        this.is_kis = true;
        this.weight = 2;
        this.length = 1000;
        this.char = this.weight;
        this.kf = 1;
      } else {
        this.is_kis = false;
      }
      if (this.ed_izm === "шт") {
        this.pi_flag = true;
      } else {
        this.pi_flag = false;
      }
      this.pm_select_flag = false;
      if (this.ed_izm === "пог. м" || this.ed_izm === "пог.м") {
        if (this.width !== "" && this.width !== 0) {
          this.pm_select_flag = true;
        }
      }
      this.prices = [];
      obj = $("tr[lolid='" + i_class + "']");
      this.name = $(obj).find("span.billet_item_name").text();
      if (this.is_kis === false) {
        this.char = $(obj).find($(".item_billet_select_char option:selected")).val();
        if (this.length === "0.0" || this.length === "0" || this.length === "") {
          if ($.isNumeric(this.char.replace(",", "."))) {
            this.length = this.char.replace(",", ".");
          }
        }
      }
      price_ul = $(obj).find(".selected_price");
      return $(price_ul).find("li").each((function(_this) {
        return function(index, element) {
          return _this.prices.push(($(element).children("strong").text()).replace(/\u00a0/g, "").replace(" ", "").replace(",00", "").replace(",", "."));
        };
      })(this));
    };

    Item.prototype.change_buy_count = function(count) {
      this.buy_count = Math.ceil(count);
      this.buy_length = (this.buy_count * this.length).toFixed(2);
      if ((this.ed_izm === "пог. м" || this.ed_izm === "пог.м") && this.is_kis === false) {
        this.buy_weight = (this.buy_length * this.weight * this.kf).toFixed(3);
      } else {
        this.buy_weight = ((this.buy_length * this.weight * this.kf) / 1000).toFixed(3);
      }
      $(".buy_weight").removeClass("preloading");
      $(".buy_count").removeClass("preloading");
      if (this.pm_select_flag) {
        $(".wpm").removeClass("preloading");
      }
      return this.change_modal();
    };

    Item.prototype.change_buy_length = function(length) {
      this.buy_length = length.replace(/,+/g, ".");
      this.buy_count = this.buy_length / this.length;
      this.change_modal();
      return $(".buy_count").change();
    };

    Item.prototype.change_buy_weight = function(weight) {
      this.buy_weight = weight.replace(/,+/g, ".");
      if (this.is_measureable()) {
        if (this.ed_izm === "пог. м" || this.ed_izm === "пог.м") {
          this.buy_length = (this.buy_weight / this.weight) / this.kf;
        } else {
          this.buy_length = ((this.buy_weight * 1000) / this.weight) / this.kf;
        }
        $(".buy_length").change();
        if (this.ai_flag) {
          this.change_buy_length(this.buy_length.toString());
        }
      }
      return this.change_modal();
    };

    Item.prototype.change_wpm = function(wpm) {
      this.buy_wpm = wpm.replace(/,+/g, ".");
      if (this.work_width !== "") {
        this.buy_count = Math.ceil(this.buy_wpm / this.work_width);
      } else {
        this.buy_count = Math.ceil(this.buy_wpm / this.width);
      }
      $(".buy_count").val(this.buy_count);
      return $(".buy_count").change();
    };

    Item.prototype.change_modal = function() {
      var buy_square, ch_arr, unit_square;
      if (this.is_measureable()) {
        $(".buy_count").val(this.buy_count);
        $(".buy_length").html(this.buy_length);
        if (this.ai_flag === "s" && !this.is_kis) {
          if (this.char.indexOf("*") !== -1) {
            ch_arr = this.char.split("*");
            if ($(ch_arr).length = 2) {
              unit_square = (ch_arr[0].replace(/,+/g, ".")) * (ch_arr[1].replace(/,+/g, "."));
              buy_square = (unit_square * this.buy_count).toFixed(3);
              $(".buy_square").html(buy_square);
            }
          } else {
            unit_square = parseFloat(this.char.replace(/,+/g, ".")) * parseFloat(this.width.replace(/,+/g, "."));
            buy_square = (unit_square * this.buy_count).toFixed(3);
            $(".buy_square").html(buy_square);
          }
        }
      }
      if (this.is_kis) {
        $(".char_length").val(this.weight);
        if (this.work_width !== "") {
          buy_square = (this.weight * this.work_width * this.buy_count).toFixed(3);
        } else {
          buy_square = (this.weight * this.buy_weight * this.buy_count).toFixed(3);
        }
        $(".buy_square").html(buy_square);
      }
      $(".buy_weight").val(this.buy_weight);
      if (this.pm_select_flag) {
        if (this.work_width !== "") {
          this.buy_wpm = (this.buy_count * this.work_width).toFixed(3);
        } else {
          this.buy_wpm = (this.buy_count * this.width).toFixed(3);
        }
        $(".wpm").val(this.buy_wpm);
      }
      return this.change_modal_price();
    };

    Item.prototype.change_modal_price = function() {
      var price_pm;
      this.set_price_weight();
      if (this.is_measureable()) {
        this.price_length = ((this.price_weight / 1000) * this.weight).toFixed(2);
        this.price_count = ((this.price_weight * this.buy_weight) / this.buy_count).toFixed(2);
        $(".price_count").html(this.price_count);
        if (this.work_width !== "") {
          price_pm = (1 / this.work_width * this.price_count).toFixed(2);
        } else {
          price_pm = (1 / this.width * this.price_count).toFixed(2);
        }
        $(".price_pm").html(price_pm);
      }
      $(".price_weight").html(this.price_weight);
      return this.set_final_price();
    };

    Item.prototype.set_price_weight = function() {
      var price_index;
      if (this.ed_izm === "т") {
        price_index = App.MyBasket._active_price_measured;
      }
      if (this.ed_izm === "пог. м" || this.ed_izm === "пог.м") {
        price_index = App.MyBasket._active_rm_price_measured;
      } else {
        price_index = 0;
      }
      return this.price_weight = (+this.prices[price_index]).toFixed(2);
    };

    Item.prototype.set_final_price = function() {
      this.set_price_weight();
      this.final_price = (this.buy_weight * this.price_weight).toFixed(2);
      return $(".final_price").html(this.final_price);
    };

    Item.prototype.change_char_length = function(n_length) {
      n_length = n_length.replace(/,+/g, ".");
      if (n_length < this.min_length) {
        n_length = this.min_length;
      } else if (n_length > this.max_length) {
        n_length = this.max_length;
      }
      this.weight = n_length;
      this.char = this.weight;
      return this.change_buy_count($(".buy_count").val());
    };

    Item.prototype.show_modal = function() {
      var my_css, time_out_handle;
      time_out_handle = 0;
      my_css = {
        width: '450px',
        height: 'auto',
        paddingTop: '10px',
        paddingBottom: '10px'
      };
      $.blockUI({
        message: this.get_modal(),
        css: my_css
      });
      $(".blockMsg").draggable();
      $(document).on("keyup", function(e) {
        e.preventDefault();
        if (e.which === 27) {
          return $.unblockUI();
        }
      });
      $(".close_button").click(function() {
        return $.unblockUI();
      });
      if (this.is_measureable()) {
        $(".buy_count").bind('change', (function(_this) {
          return function(event) {
            return _this.change_buy_count($(".buy_count").val());
          };
        })(this));
        $(".buy_count").bind('keyup', (function(_this) {
          return function(event) {
            $(".buy_weight").addClass("preloading");
            if (_this.pm_select_flag) {
              $(".wpm").addClass("preloading");
            }
            window.clearTimeout(time_out_handle);
            return time_out_handle = window.setTimeout((function() {
              return _this.change_buy_count($(".buy_count").val());
            }), 1000);
          };
        })(this));
        $(".buy_length").bind('change keyup', (function(_this) {
          return function(event) {
            window.clearTimeout(time_out_handle);
            return time_out_handle = window.setTimeout((function() {
              return _this.change_buy_length($(".buy_length").html());
            }), 1000);
          };
        })(this));
      }
      $(".buy_weight").bind('change keyup', (function(_this) {
        return function(event) {
          $(".buy_count").addClass("preloading");
          window.clearTimeout(time_out_handle);
          return time_out_handle = window.setTimeout((function() {
            return _this.change_buy_weight($(".buy_weight").val());
          }), 1000);
        };
      })(this));
      if (this.is_kis) {
        $(".char_length").bind('change keyup', (function(_this) {
          return function(event) {
            $(".buy_weight").addClass("preloading");
            window.clearTimeout(time_out_handle);
            return time_out_handle = window.setTimeout((function() {
              return _this.change_char_length($(".char_length").val());
            }), 1000);
          };
        })(this));
      }
      if (this.pm_select_flag) {
        $(".wpm").bind('change keyup', (function(_this) {
          return function(event) {
            $(".buy_count").addClass("preloading");
            window.clearTimeout(time_out_handle);
            return time_out_handle = window.setTimeout((function() {
              return _this.change_wpm($(".wpm").val());
            }), 1000);
          };
        })(this));
      }
      this.change_modal_price();
      $(".add_to_basket").bind('click', (function(_this) {
        return function(event) {
          App.MyBasket.add_item(_this);
          return $.unblockUI();
        };
      })(this));
      $(".change_in_basket").bind('click', (function(_this) {
        return function(event) {
          App.MyBasket.change_item_from_modal(_this);
          return $.unblockUI();
        };
      })(this));
      yaCounter23067595.reachGoal('OpenItem');
      $(".set_to_w").bind('click', (function(_this) {
        return function(event) {
          $(".buy_weight").parent().hide();
          $(".price_weight").hide();
          $(".wpm").parent().show();
          $(".price_pm").show();
          $(".pm_choice_cont").css("background-image", "url('images/pm_choice_arrows_w.png')");
          $(".set_to_w").addClass("sc_active");
          return $(".set_to_l").removeClass("sc_active");
        };
      })(this));
      return $(".set_to_l").bind('click', (function(_this) {
        return function(event) {
          $(".wpm").parent().hide();
          $(".price_pm").hide();
          $(".buy_weight").parent().show();
          $(".price_weight").show();
          $(".pm_choice_cont").css("background-image", "url('images/pm_choice_arrows_l.png')");
          $(".set_to_l").addClass("sc_active");
          return $(".set_to_w").removeClass("sc_active");
        };
      })(this));
    };

    Item.prototype.get_modal = function() {
      var buy_square, c_input, c_izm, ch_arr, cl_input, edizm_dict, hide_opt, l_input, message, modal_link, pmcc, ppm, set_length, unit_square, w_input, wpm;
      if (App.MyBasket.is_in_basket(this)) {
        modal_link = '<a class="change_in_basket" href="javascript:void(0)">Изменить</a>';
      } else {
        modal_link = '<a class="add_to_basket" href="javascript:void(0)">В корзину</a>';
      }
      if (this.is_measureable()) {
        c_input = '<input class="buy_count" pattern="[0-9]+" value="' + this.buy_count + '" />';
        if (this.ai_flag === "l") {
          l_input = "<div class=\"length_item_overall\">Общий метраж: <span class=\"buy_length\">" + this.buy_length + "</span></div>";
        } else if (this.ai_flag === "s" && !this.is_kis) {
          if (this.char.indexOf("*") !== -1) {
            ch_arr = this.char.split("*");
            if ($(ch_arr).length = 2) {
              unit_square = (ch_arr[0].replace(/,+/g, ".")) * (ch_arr[1].replace(/,+/g, "."));
              buy_square = (unit_square * this.buy_count).toFixed(3);
              l_input = "<div class=\"length_item_overall\">Общая площадь: <span class=\"buy_square\">" + buy_square + "</span></div>";
            }
          } else {
            unit_square = parseFloat(this.char.replace(/,+/g, ".")) * parseFloat(this.width.replace(/,+/g, "."));
            buy_square = (unit_square * this.buy_count).toFixed(3);
            $(".buy_square").html(buy_square);
            l_input = "<div class=\"length_item_overall\">Общая площадь: <span class=\"buy_square\">" + buy_square + "</span></div>";
          }
        } else {
          l_input = "";
        }
      } else {
        c_input = '<input class="buy_count" value="---" disabled />';
        l_input = "";
      }
      w_input = '<input class="buy_weight" pattern="[0-9,\\.]+" value="' + this.buy_weight + '" />';
      if (this.is_kis) {
        cl_input = '<input class="char_length" pattern="[0-9,\\.]+" value="' + this.weight + '" />';
        set_length = "<p class=\"list_length\">Укажите требуемую длину листа: " + cl_input + "</p>";
        if (this.work_width !== "") {
          buy_square = (this.weight * this.work_width * this.buy_count).toFixed(3);
        } else {
          buy_square = (this.weight * this.buy_weight * this.buy_count).toFixed(3);
        }
        l_input = "<div class=\"length_item_overall\">Рабочая площадь: <span class=\"buy_square\">" + buy_square + "</span></div>";
      } else {
        set_length = "";
      }
      if (this.pi_flag) {
        hide_opt = "hide_opt";
      } else {
        hide_opt = "";
      }
      edizm_dict = {
        "т": "Тонны",
        "шт": "Штуки",
        "м2": "Метры кв.",
        "кв.м.": "Метры кв.",
        "кв. м.": "Метры кв.",
        "пог.м": "Метры пог.",
        "пог. м": "Метры пог."
      };
      c_izm = edizm_dict["" + this.ed_izm];
      if (this.pm_select_flag) {
        wpm = "<td class=\"wpm_td\" style=\"display:none;\">\n    <input class=\"wpm\" patter=\"[0-9,\\.]+\" value=\"" + this.buy_wpm + "\" />\n</td>";
        ppm = "<td class=\"price_pm\" style=\"display:none;\">0</td>";
        pmcc = "<div class=\"pm_choice_cont\">\n    Расчет пог. метров по\n    <span class=\"set_cont\">\n        <span class=\"set_to_l sc_active\">длине</span>\n        <span class=\"set_to_w\">ширине</span>\n    </span>\n</div>";
      } else {
        wpm = "";
        ppm = "";
        pmcc = "";
      }
      message = "<div class=\"buy_item_div\">\n<span class=\"close_button\">x</span>\n<span class=\"buy_item_name\">" + this.name + "</span> <br />\n<span class=\"buy_item_name\">Длина: " + this.char + "</span>\n" + set_length + "\n<table class=\"buy_item_table\">\n<tr class=\"buy_item_head\">\n<th></th>\n\n<th class=\"" + hide_opt + "\">Штуки</th>\n<th>" + c_izm + "</th>\n</tr>\n<tr class=\"buy_item_count\">\n<td>Количество</td>\n\n<td class=\"" + hide_opt + "\">\n    " + c_input + "\n</td>\n<td>\n    " + w_input + "\n</td>\n" + wpm + "\n</tr>\n<tr class=\"buy_item_price\">\n<td>Стоимость за ед.</td>\n<td class=\"price_count " + hide_opt + "\">0</td>\n<td class=\"price_weight\">0</td>\n" + ppm + "\n</tr>\n\n</table>\n\n\n" + pmcc + "\n<div class=\"buy_item_overall\">Итого: <span class=\"final_price\"></span></div>\n" + l_input + "\n<div class=\"basket_item_overall\">*В корзине товар на: <span class=\"basket_price\">" + App.MyBasket._sum + "</span></div>\n\n<span class=\"popUpContinue\">" + modal_link + "</span>\n        </div>";
      return message;
    };

    return Item;

  })();

}).call(this);
