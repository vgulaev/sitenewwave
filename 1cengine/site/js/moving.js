// Generated by CoffeeScript 1.6.3
(function() {
  var showGroup2, show_groups, switch_tabs, tabs, tabs_dict;

  Array.prototype.toDict = function(key) {
    return this.reduce((function(dict, obj) {
      if (obj[key] != null) {
        dict[obj[key]] = obj;
      }
      return dict;
    }), {});
  };

  tabs = [
    {
      id: "tabBasket",
      other: ["basketDiv", "showPriceSpan"],
      counter: ["tabPrice"]
    }, {
      id: "tabPrice",
      other: ["pTableContentTab", "showBasketSpan"],
      counter: ["tabBasket"]
    }, {
      id: "closeBasket",
      other: ["pTableContentTab", "showBasketSpan"],
      counter: ["tabBasket"]
    }, {
      id: "switchOrderDiv",
      other: ["orderDiv", "showNDSlabel"],
      counter: ["switchDeliveryDiv", "switchNotificationDiv"],
      active_class: "activeDiv",
      inactive_class: "inactiveDiv"
    }, {
      id: "switchDeliveryDiv",
      other: ["deliveryDiv"],
      counter: ["switchOrderDiv", "switchNotificationDiv"],
      active_class: "activeDiv",
      inactive_class: "inactiveDiv"
    }, {
      id: "switchNotificationDiv",
      other: ["notificationDiv"],
      counter: ["switchOrderDiv", "switchDeliveryDiv"],
      active_class: "activeDiv",
      inactive_class: "inactiveDiv"
    }
  ];

  tabs_dict = tabs.toDict("id");

  switch_tabs = function(id) {
    var counter, counters, other, _i, _j, _k, _len, _len1, _len2, _ref, _ref1;
    counters = tabs_dict[id]["counter"];
    for (_i = 0, _len = counters.length; _i < _len; _i++) {
      counter = counters[_i];
      _ref = tabs_dict[counter]["other"];
      for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
        other = _ref[_j];
        $("#" + other).hide();
      }
      if (tabs_dict[counter]["active_class"]) {
        $("#" + tabs_dict[counter]['id']).removeClass(tabs_dict[counter]['active_class']);
      }
      if (tabs_dict[counter]["inactive_class"]) {
        $("#" + tabs_dict[counter]['id']).addClass(tabs_dict[counter]['inactive_class']);
      }
    }
    _ref1 = tabs_dict[id]["other"];
    for (_k = 0, _len2 = _ref1.length; _k < _len2; _k++) {
      other = _ref1[_k];
      $("#" + other).show();
    }
    if (tabs_dict[id]["active_class"]) {
      $("#" + id).addClass(tabs_dict[id]['active_class']);
    }
    if (tabs_dict[id]["inactive_class"]) {
      return $("#" + id).removeClass(tabs_dict[id]['inactive_class']);
    }
  };

  show_groups = function() {
    $.blockUI.defaults.css.borderRadius = '10px';
    $.blockUI.defaults.fadeIn = 100;
    $.blockUI.defaults.fadeOut = 100;
    $.blockUI.defaults.css.backgroundColor = 'white';
    $.blockUI.defaults.css.cursor = 'defaults';
    $.blockUI.defaults.css.boxShadow = '0px 0px 5px 5px rgb(207, 207, 207)';
    $.blockUI.defaults.css.fontSize = '14px';
    $.blockUI.defaults.css.width = '700px';
    $.blockUI.defaults.css.height = '370px';
    $.blockUI.defaults.css.paddingTop = '70px';
    $.blockUI.defaults.css.paddingLeft = '20px';
    $.blockUI({
      message: $("#tags")
    });
    $(".blockMsg").draggable();
    return $(document).on("keyup", function(e) {
      e.preventDefault();
      if (e.which === 27) {
        return $.unblockUI();
      }
    });
  };

  showGroup2 = function(term) {
    $("#itemName").val(term);
    $("#itemName").change();
    return $.unblockUI();
  };

  $(document).ready(function() {
    var PAGE, item, name,
      _this = this;
    PAGE = 1;
    if ($("#tags").css("display") === "none") {
      $("#showGroupsDiv").show();
    }
    for (item in tabs_dict) {
      name = item;
      $("#" + name).click(function() {
        return switch_tabs(this.id);
      });
    }
    $("#itemName").autocomplete({
      source: "/1cengine/py_scripts/item_autocomplete.py",
      autoFocus: true,
      minLength: 0,
      select: function(event, ui) {
        $(this).val(ui.item.label);
        $(this).change();
        $(this).blur();
        return $(this).click();
      }
    }, 0).click(function() {
      return $(this).autocomplete("search", $(this).val());
    });
    $("#itemName").change(function() {
      var value;
      $("#groupDiv").hide();
      value = $("#itemName").val();
      value = value.replace("+", " ");
      $.ajax({
        type: "GET",
        url: "/1cengine/py_scripts/get_items_bs.py",
        async: true,
        data: "term=" + encodeURIComponent(value) + "",
        success: function(html) {
          $("#qRes").html(html);
          if ($(".item").length >= 1) {
            $("#tags").hide();
            $("#showGroupsDiv").show();
            $("#hollowResult").empty();
          } else {
            $("#hollowResult").html("Извините, но по заданному запросу товар не найден");
            $("#tags").show();
            $("#showGroupsDiv").hide();
          }
          if ($(".item").length === 20) {
            $("#showAll").show();
          } else {
            $("#showAll").hide();
          }
          window.history.pushState({
            term: value
          }, '', '/1cengine/site/' + $.trim(value) + '/');
          return $("#show_groups").show();
        }
      });
      return $.ajax({
        type: "GET",
        url: "/1cengine/py_scripts/get_count_items.py",
        async: true,
        data: "term=" + encodeURIComponent(value) + "",
        success: function(html) {
          return $(".count_all_result").html(html);
        }
      });
    });
    $(window).on("popstate", function(e) {
      $("#itemName").val(history.state['term']);
      return $("#itemName").change();
    });
    $("#showNds").change(function() {
      if (this.checked) {
        return $(".NDSHeader, .itemNdsSumTd, .itemNdsKfTd, .ndsAllsum").show();
      } else {
        return $(".NDSHeader, .itemNdsSumTd, .itemNdsKfTd, .ndsAllsum").hide();
      }
    });
    $("#show_groups").click(function() {
      return show_groups();
    });
    $("#showAll").click(function() {
      var value;
      value = $("#itemName").val();
      value = value.replace("+", " ");
      return $.ajax({
        type: "GET",
        url: "/1cengine/py_scripts/get_items_bs.py",
        async: true,
        data: "term=" + encodeURIComponent(value) + "&show_all=true",
        success: function(html) {
          $("#qRes").html(html);
          if ($(".item").length >= 1) {
            $("#tags").hide();
            $("#showGroupsDiv").show();
            $("#hollowResult").empty();
          } else {
            $("#hollowResult").html("Извините, но по заданному запросу товар не найден");
            $("#tags").show();
            $("#showGroupsDiv").hide();
          }
          if ($(".item").length === 20) {
            return $("#showAll").show();
          } else {
            return $("#showAll").hide();
          }
        }
      });
    });
    $(".next_result").click(function() {
      var value;
      value = $("#itemName").val();
      value = value.replace("+", " ");
      return $.ajax({
        type: "GET",
        url: "/1cengine/py_scripts/get_items_bs.py",
        async: true,
        data: "term=" + encodeURIComponent(value) + "&page=" + PAGE + 1 + "",
        success: function(html) {
          $("#qRes").html(html);
          return PAGE = PAGE + 1;
        }
      });
    });
    $(".prev_result").click(function() {
      var n_page, value;
      value = $("#itemName").val();
      value = value.replace("+", " ");
      if (PAGE !== 1) {
        n_page = PAGE - 1;
        return $.ajax({
          type: "GET",
          url: "/1cengine/py_scripts/get_items_bs.py",
          async: true,
          data: "term=" + encodeURIComponent(value) + "&page=" + n_page + "",
          success: function(html) {
            $("#qRes").html(html);
            return PAGE = PAGE - 1;
          }
        });
      }
    });
    return $("#groups_list").find("li.main_group").each(function(index, element) {
      return $(element).click(function() {
        var g_name;
        $("#groups_list").find("li.main_group").removeClass("active_group");
        $(element).addClass("active_group");
        g_name = $(this).attr("name");
        $("#itemName").val(g_name);
        $("#itemName").change();
        if ($(element).children().is(".subgroup") === false) {
          $(element).append("<ul class=\"subgroup\"></ul>");
          return $.ajax({
            type: "GET",
            url: "/1cengine/py_scripts/item_autocomplete.py",
            async: true,
            data: "term=" + encodeURIComponent(g_name) + "",
            success: function(html) {
              var subgroup, subgroups, _i, _len, _results,
                _this = this;
              subgroups = JSON.parse(html);
              _results = [];
              for (_i = 0, _len = subgroups.length; _i < _len; _i++) {
                subgroup = subgroups[_i];
                _results.push((function(subgroup) {
                  return $(element).find("ul").append("<li>" + subgroup.replace(g_name, "") + "</li>");
                })(subgroup));
              }
              return _results;
            }
          });
        }
      });
    });
  });

}).call(this);
